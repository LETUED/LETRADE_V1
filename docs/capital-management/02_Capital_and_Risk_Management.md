# ìë³¸ ë° ë¦¬ìŠ¤í¬ ê´€ë¦¬ (Capital and Risk Management)

## ğŸ“‹ ë¬¸ì„œ ê°œìš”

**ë¬¸ì„œ ëª©ì **: ìë™ ì•”í˜¸í™”í ê±°ë˜ ì‹œìŠ¤í…œì˜ ì¬ë¬´ì  ì•ˆì •ì„±ê³¼ í™•ì¥ì„±ì„ ë³´ì¥í•˜ëŠ” í•µì‹¬ êµ¬ì„± ìš”ì†Œì¸ ìê¸ˆ ë° ë¦¬ìŠ¤í¬ ê´€ë¦¬ ëª¨ë“ˆì˜ ìƒì„¸ ì„¤ê³„ ëª…ì„¸ì„œ

**ì‹œìŠ¤í…œ ì§„í™”**: 
- **ê¸°ì¡´**: ê°œë³„ ì „ëµ ì‹¤í–‰ê³¼ ê±°ë˜ì†Œ ì—°ë™ì— ì¤‘ì 
- **ëª©í‘œ**: ì†Œê·œëª¨ íˆ¬ìë¶€í„° ê¸°ê´€ê¸‰ ëŒ€ê·œëª¨ ìë³¸ ìš´ìš©ê¹Œì§€ í¬ê´„í•˜ëŠ” ì •êµí•œ ì¤‘ì•™ ì§‘ì¤‘í™”ëœ ìê¸ˆ ê´€ë¦¬ ì²´ê³„

**í•µì‹¬ ê°€ì¹˜**: ì‹œìŠ¤í…œì„ ë‹¨ìˆœí•œ ê±°ë˜ ì‹¤í–‰ ë„êµ¬ì—ì„œ **ì§€ëŠ¥ì ì¸ í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë¦¬ í”Œë«í¼**ìœ¼ë¡œ ê²©ìƒ

---

## ğŸ—ï¸ 1. ì•„í‚¤í…ì²˜ ì§„í™”: Capital Manager ì„œë¹„ìŠ¤ ë„ì…

### 1.1 ì„¤ê³„ ë°°ê²½ ë° í•„ìš”ì„±

**ê¸°ì¡´ êµ¬ì¡°ì˜ í•œê³„**:
- âŒ Strategy Worker â†’ Exchange Connector ì§ì ‘ ì—°ê²°
- âŒ í¬íŠ¸í´ë¦¬ì˜¤ ìˆ˜ì¤€ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë¶€ì¬
- âŒ ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP) ìœ„ë°° ìœ„í—˜

**í•´ê²° ë°©ì•ˆ**:
- âœ… **Capital Manager** ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì‹ ê·œ ë„ì…
- âœ… ìë³¸ í• ë‹¹ ë° í¬íŠ¸í´ë¦¬ì˜¤ ë¦¬ìŠ¤í¬ ê´€ë¦¬ì˜ ì¤‘ì•™ í—ˆë¸Œ
- âœ… ëª¨ë“  ê±°ë˜ íë¦„ì„ í†µì œí•˜ëŠ” í•µì‹¬ ê²Œì´íŠ¸í‚¤í¼

### 1.2 ì•„í‚¤í…ì²˜ ë³€í™”: ê¸°ì¡´ vs ì‹ ê·œ

#### **ê¸°ì¡´ êµ¬ì¡°**:
```
Strategy Worker â†’ ê±°ë˜ ì‹ í˜¸ ìƒì„± â†’ Exchange Connector â†’ ì§ì ‘ ì£¼ë¬¸ ì‹¤í–‰
```

#### **ì‹ ê·œ êµ¬ì¡°**:
```
Strategy Worker â†’ ê±°ë˜ 'ì œì•ˆ' ìƒì„± â†’ Capital Manager â†’ ê²€í† /ìŠ¹ì¸/ê·œëª¨ ê²°ì • â†’ Exchange Connector â†’ ì£¼ë¬¸ ì‹¤í–‰
```

### 1.3 Capital Manager: ìƒˆë¡œìš´ ì¤‘ì•™ ê¶Œí•œ

**í•µì‹¬ ì •ì˜**: ì‹œìŠ¤í…œ ë‚´ì—ì„œ ìë³¸ê³¼ ê´€ë ¨ëœ ëª¨ë“  ì˜ì‚¬ê²°ì •ì„ ë‚´ë¦¬ëŠ” **ìœ ì¼í•œ ì£¼ì²´**

#### ğŸ¯ **í•µì‹¬ ì±…ì„ (5ëŒ€ ì˜ì—­)**

#### **1. í¬íŠ¸í´ë¦¬ì˜¤ ìƒíƒœ ê´€ë¦¬**
- **ì—­í• **: ëª¨ë“  ìë³¸ í’€(Capital Pool)ê³¼ í•˜ìœ„ í¬íŠ¸í´ë¦¬ì˜¤ ì‹¤ì‹œê°„ ì¶”ì 
- **ê´€ë¦¬ ë°ì´í„°**: ì´ ìë³¸, ê°€ìš© ìë³¸, í˜„ì¬ ì†ìµ
- **ì˜ì†í™”**: ë°ì´í„°ë² ì´ìŠ¤ì— ì‹¤ì‹œê°„ ìƒíƒœ ì €ì¥

#### **2. ìë³¸ í• ë‹¹ ìš”ì²­ ì²˜ë¦¬**
- **ì…ë ¥**: Strategy Workerë¡œë¶€í„°ì˜ ê±°ë˜ ì‹ í˜¸ ê¸°ë°˜ ìë³¸ í• ë‹¹ ìš”ì²­
- **ì²˜ë¦¬**: ìš”ì²­ ê²€ì¦ ë° ìŠ¹ì¸/ê±°ë¶€ ê²°ì •

#### **3. í¬íŠ¸í´ë¦¬ì˜¤ ë¦¬ìŠ¤í¬ ê·œì¹™ ê°•ì œ**
- **ì ìš© ë²”ìœ„**: í¬íŠ¸í´ë¦¬ì˜¤ ìˆ˜ì¤€ì—ì„œ ì •ì˜ëœ ëª¨ë“  ë¦¬ìŠ¤í¬ ê·œì¹™
- **ê·œì¹™ ì˜ˆì‹œ**: ìµœëŒ€ ì†ì‹¤ë¥ , ìì‚°ë³„ ìµœëŒ€ ë…¸ì¶œë„
- **ê²°ê³¼**: ê·œì¹™ ìœ„ë°˜ ê±°ë˜ ìë™ ê±°ë¶€

#### **4. í¬ì§€ì…˜ ê·œëª¨ ê²°ì •**
- **ê¸°ë°˜**: ê° ì „ëµì— ì‚¬ì „ êµ¬ì„±ëœ í¬ì§€ì…˜ ì‚¬ì´ì§• ëª¨ë¸
- **ëª¨ë¸ ì¢…ë¥˜**: ê³ ì • ë¹„ìœ¨, ì¼ˆë¦¬ ê¸°ì¤€, ë³€ë™ì„± ê¸°ë°˜
- **ì‚°ì¶œ**: ìµœì¢… ì£¼ë¬¸ ìˆ˜ëŸ‰ ê³„ì‚°

#### **5. ì£¼ë¬¸ ì‹¤í–‰ ëª…ë ¹ ë°œí–‰**
- **ì¡°ê±´**: ëª¨ë“  ê²€ì¦ ì ˆì°¨ í†µê³¼í•œ ê±°ë˜ì— ëŒ€í•´ì„œë§Œ
- **ë‚´ìš©**: ìµœì¢… íŒŒë¼ë¯¸í„° (ì‹¬ë³¼, ìˆ˜ëŸ‰, ê°€ê²© ë“±)
- **ëŒ€ìƒ**: Exchange Connectorê°€ êµ¬ë…í•˜ëŠ” íë¡œ `commands.execute_trade` ë©”ì‹œì§€ ë°œí–‰

### 1.4 ì„¤ê³„ íš¨ê³¼

**ì•ˆì „ì¥ì¹˜**: ë‹¨ì¼ ë¶ˆëŸ‰ ì „ëµì´ ì „ì²´ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ìœ„í—˜ì— ë¹ ëœ¨ë¦¬ëŠ” ê²ƒì„ ì›ì²œì ìœ¼ë¡œ ë°©ì§€
**í•„ìˆ˜ì„±**: ëŒ€ê·œëª¨ ìê¸ˆ ìš´ìš©ì„ ìœ„í•œ í•„ìˆ˜ì ì¸ ì•„í‚¤í…ì²˜ íŒ¨í„´
**ë¶„ë¦¬**: ê°œë³„ ì „ëµì˜ ë…¼ë¦¬ì™€ í¬íŠ¸í´ë¦¬ì˜¤ ì „ì²´ì˜ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ëª…í™• ë¶„ë¦¬

---

## ğŸ“¡ 2. ì§„í™”ëœ ë°ì´í„° íë¦„ ë° ë©”ì‹œì§•

### 2.1 í•µì‹¬ ë³€í™”

**ëª©í‘œ**: Capital Manager ë„ì…ì— ë”°ë¥¸ RabbitMQ ë©”ì‹œì§€ ë²„ìŠ¤ ë°ì´í„° íë¦„ ì¬ì •ì˜
**ì›ì¹™**: ì‹œìŠ¤í…œì˜ **ë¹„ë™ê¸°ì  íŠ¹ì„±**ê³¼ **ë³µì›ë ¥** ìœ ì§€í•˜ë©´ì„œ ìƒˆë¡œìš´ ê¸°ëŠ¥ í†µí•©

### 2.2 ì‹ ê·œ ë©”ì‹œì§€ ìœ í˜•

#### ğŸ“¤ **request.capital.allocation**
**ë°œí–‰ì**: Strategy Worker (ê±°ë˜ ì‹ í˜¸ ìƒì„± ì‹œ)
**ì˜ë¯¸**: ì§ì ‘ì ì¸ ì£¼ë¬¸ ëª…ë ¹ì´ ì•„ë‹Œ, ìë³¸ í• ë‹¹ì„ ìœ„í•œ 'ìš”ì²­'

```json
{
  "routing_key": "request.capital.allocation.{strategy_id}",
  "payload": {
    "strategy_id": 123,
    "symbol": "BTC/USDT",
    "side": "buy",
    "entry_price": 50000.0,
    "stop_loss_price": 48000.0,
    "strategy_params": {...}
  }
}
```

#### âœ… **event.capital.approved**
**ë°œí–‰ì**: Capital Manager (ìë³¸ í• ë‹¹ ìš”ì²­ ìŠ¹ì¸ ì‹œ)
**ì˜ë¯¸**: ê¸°ì¡´ `commands.execute_trade` ë©”ì‹œì§€ ëŒ€ì²´

```json
{
  "routing_key": "commands.execute_trade",
  "payload": {
    "strategy_id": 123,
    "symbol": "BTC/USDT",
    "side": "buy",
    "type": "market",
    "amount": 0.1,
    "price": 50000.0
  }
}
```

#### âŒ **event.capital.denied**
**ë°œí–‰ì**: Capital Manager (ìš”ì²­ ê±°ë¶€ ì‹œ)
**ì˜ë¯¸**: í¬íŠ¸í´ë¦¬ì˜¤ ë¦¬ìŠ¤í¬ ê·œì¹™ ìœ„ë°˜ ë“±ìœ¼ë¡œ ì¸í•œ ê±°ë¶€

```json
{
  "routing_key": "event.capital.denied.{strategy_id}",
  "payload": {
    "strategy_id": 123,
    "reason": "Max drawdown limit exceeded",
    "request_payload": {...}
  }
}
```

### 2.3 ì§„í™”ëœ ë°ì´í„° íë¦„ ë‹¤ì´ì–´ê·¸ë¨

```mermaid
graph TD
    subgraph "User Interfaces"
        A[CLI]
        B[Telegram UI]
    end

    subgraph "System Services"
        C[Core Engine]
        D[Strategy Worker]
        E[Capital Manager]
        F[Exchange Connector]
        G[Telegram Interface]
    end

    subgraph "Infrastructure"
        H{RabbitMQ Bus}
        I[Cloud SQL DB]
    end

    subgraph "External"
        K[Exchanges]
    end

    A & B --> G
    G <--> H
    C <--> H
    C <--> I
    D -- "1. request.capital.allocation" --> H
    H -- "2. Routes request" --> E
    E <--> I
    E -- "3. commands.execute_trade" --> H
    H -- "4. Routes command" --> F
    F <--> K
    F -- "5. events.trade_executed" --> H
    H -- "6. Distributes event" --> D & C & G
```

### 2.4 ë‹¨ê³„ë³„ ë°ì´í„° íë¦„

1. **ì‹ í˜¸ ìƒì„± ë° ìë³¸ ìš”ì²­**: Strategy Worker â†’ `request.capital.allocation` â†’ RabbitMQ
2. **ìë³¸ ê´€ë¦¬ì ìˆ˜ì‹ **: Capital Manager â† RabbitMQ
3. **ìŠ¹ì¸ ë° ì£¼ë¬¸ ëª…ë ¹**: Capital Manager â†’ ê²€ì¦ â†’ í¬ì§€ì…˜ ê·œëª¨ ê³„ì‚° â†’ `commands.execute_trade` â†’ RabbitMQ
4. **ê±°ë˜ ì‹¤í–‰ê¸° ìˆ˜ì‹ **: Exchange Connector â† RabbitMQ
5. **ê±°ë˜ ì‹¤í–‰ ë° ì´ë²¤íŠ¸ ë°œí–‰**: Exchange Connector â†’ ê±°ë˜ì†Œ ì£¼ë¬¸ â†’ `events.trade_executed` â†’ RabbitMQ
6. **ìƒíƒœ ì—…ë°ì´íŠ¸**: Strategy Worker, Core Engine, Telegram Interface â† ê±°ë˜ ì™„ë£Œ ì´ë²¤íŠ¸

---

## ğŸ›ï¸ 3. ê³„ì¸µì  í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë¦¬

### 3.1 ì„¤ê³„ ëª©ì 

**ìš”êµ¬ì‚¬í•­**: ì†Œê·œëª¨ íˆ¬ìë¶€í„° ëŒ€ê·œëª¨ íˆ¬ìê¹Œì§€ ëª¨ë‘ ì²˜ë¦¬
**êµ¬í˜„**: ë°ì´í„°ë² ì´ìŠ¤ê°€ ìë³¸ì˜ ê³„ì¸µ êµ¬ì¡°ì™€ ê´€ë ¨ ê·œì¹™ì„ ëª…í™•í•˜ê²Œ í‘œí˜„

### 3.2 ë°ì´í„° ëª¨ë¸ í™•ì¥

#### ğŸ“Š **ì‹ ê·œ í…Œì´ë¸”: portfolios**

**ëª©ì **: ìë³¸ì„ ê´€ë¦¬í•˜ëŠ” ìµœìƒìœ„ ë‹¨ìœ„
**íŠ¹ì§•**: ê³„ì¸µ êµ¬ì¡° ì§€ì› ('ê¸€ë¡œë²Œ' í¬íŠ¸í´ë¦¬ì˜¤ â†’ 'í˜„ë¬¼', 'ì„ ë¬¼', 'ì‹¤í—˜ì  ì „ëµ' í•˜ìœ„ í¬íŠ¸í´ë¦¬ì˜¤)

| ì»¬ëŸ¼ëª… | ë°ì´í„° íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|-------------|----------|------|
| `id` | SERIAL | PRIMARY KEY | í¬íŠ¸í´ë¦¬ì˜¤ ê³ ìœ  ID |
| `name` | VARCHAR(255) | NOT NULL | í¬íŠ¸í´ë¦¬ì˜¤ ì´ë¦„ (ì˜ˆ: "Global", "Futures High-Risk") |
| `parent_id` | INTEGER | FK to portfolios.id | ìƒìœ„ í¬íŠ¸í´ë¦¬ì˜¤ ID (ê³„ì¸µ êµ¬ì¡° ì§€ì›) |
| `total_capital` | NUMERIC(20, 8) | NOT NULL | ì´ í¬íŠ¸í´ë¦¬ì˜¤ì— í• ë‹¹ëœ ì´ ìë³¸ (ê¸°ì¤€ í†µí™” ê¸°ì¤€) |
| `available_capital` | NUMERIC(20, 8) | NOT NULL | í˜„ì¬ ê±°ë˜ì— ì‚¬ìš© ê°€ëŠ¥í•œ ìë³¸ |
| `is_active` | BOOLEAN | DEFAULT TRUE | í¬íŠ¸í´ë¦¬ì˜¤ í™œì„±í™” ì—¬ë¶€ |

#### ğŸ“‹ **ì‹ ê·œ í…Œì´ë¸”: portfolio_rules**

**ëª©ì **: ê° í¬íŠ¸í´ë¦¬ì˜¤ì— ì ìš©ë  ë¦¬ìŠ¤í¬ ê´€ë¦¬ ê·œì¹™ ì •ì˜
**íŠ¹ì§•**: `rule_type`ê³¼ `rule_value`ë¥¼ í†µí•œ ìœ ì—°í•œ ê·œì¹™ ì¶”ê°€

| ì»¬ëŸ¼ëª… | ë°ì´í„° íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|-------------|----------|------|
| `id` | SERIAL | PRIMARY KEY | ê·œì¹™ ê³ ìœ  ID |
| `portfolio_id` | INTEGER | FK to portfolios.id | ê·œì¹™ì´ ì ìš©ë  í¬íŠ¸í´ë¦¬ì˜¤ ID |
| `rule_type` | VARCHAR(50) | NOT NULL | ê·œì¹™ ìœ í˜• (ì˜ˆ: 'MAX_DRAWDOWN_PERCENT') |
| `rule_value` | JSONB | NOT NULL | ê·œì¹™ ê°’ (ì˜ˆ: {"value": 15}) |

#### ğŸ”— **ì‹ ê·œ í…Œì´ë¸”: strategy_portfolio_map**

**ëª©ì **: ì „ëµê³¼ í¬íŠ¸í´ë¦¬ì˜¤ ê°„ì˜ ëª…ì‹œì  ì—°ê²°
**íš¨ê³¼**: íŠ¹ì • ì „ëµì´ ì§€ì •ëœ ìë³¸ í’€ ë‚´ì—ì„œë§Œ ìš´ì˜ë˜ë„ë¡ ê°•ì œ

| ì»¬ëŸ¼ëª… | ë°ì´í„° íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|-------------|----------|------|
| `strategy_id` | INTEGER | FK to strategies.id | ì „ëµ ID |
| `portfolio_id` | INTEGER | FK to portfolios.id | í¬íŠ¸í´ë¦¬ì˜¤ ID |

#### âš™ï¸ **ìˆ˜ì • í…Œì´ë¸”: strategies**

**ì¶”ê°€ ì»¬ëŸ¼**: í¬ì§€ì…˜ ì‚¬ì´ì§• ì„¤ì •

| ì»¬ëŸ¼ëª… | ë°ì´í„° íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|-------------|----------|------|
| ...... | ...... | ...... | (ê¸°ì¡´ ì»¬ëŸ¼ë“¤) |
| `position_sizing_config` | JSONB | NULL | í¬ì§€ì…˜ ì‚¬ì´ì§• ëª¨ë¸ ë° íŒŒë¼ë¯¸í„° (ì˜ˆ: {"model": "Kelly", "fraction": 0.5}) |

---

## ğŸ“ 4. í¬ì§€ì…˜ ì‚¬ì´ì§• ì•Œê³ ë¦¬ì¦˜

### 4.1 ê°œìš”

**ëª©ì **: ë¦¬ìŠ¤í¬ ê²€ì¦ì„ í†µê³¼í•œ ê±°ë˜ ìš”ì²­ì— ëŒ€í•´ ì£¼ë¬¸ í¬ê¸° ê³„ì‚°
**ê¸°ë°˜**: `strategies` í…Œì´ë¸”ì˜ `position_sizing_config`ì— ì •ì˜ëœ ëª¨ë¸
**ê°€ì¹˜**: ëª¨ë“  íˆ¬ì ê·œëª¨ì— ëŒ€ì‘í•˜ê³  ë‹¤ì–‘í•œ íˆ¬ì ë°©ì‹ ì§€ì›

### 4.2 ì•Œê³ ë¦¬ì¦˜ ìƒì„¸

#### ğŸ’° **4.2.1 ê³ ì • ë¹„ìœ¨(Fixed Fractional) ì‚¬ì´ì§•**

**íŠ¹ì§•**: ê°€ì¥ ê¸°ë³¸ì ì´ê³  ì•ˆì •ì ì¸ ëª¨ë¸
**ì›ë¦¬**: í¬íŠ¸í´ë¦¬ì˜¤ ê°€ìš© ìë³¸ì˜ ì •í•´ì§„ ë¹„ìœ¨(ì˜ˆ: 1% ë˜ëŠ” 2%)ë§Œí¼ë§Œ ë¦¬ìŠ¤í¬ ê°ìˆ˜

**ê³„ì‚°ì‹**:
```
Position Size = (Portfolio Available Capital Ã— Risk Percent) / Stop Loss Distance
```

**êµ¬í˜„ ìš”êµ¬ì‚¬í•­**:
- `stop_loss_price`ëŠ” `request.capital.allocation` ë©”ì‹œì§€ì— í¬í•¨ í•„ìˆ˜
- ë¦¬ìŠ¤í¬ë¥¼ ì¼ì •í•˜ê²Œ ìœ ì§€í•˜ì—¬ ì•ˆì •ì ì¸ ìë³¸ ê´€ë¦¬ ì‹¤í˜„

**ì„¤ì • ì˜ˆì‹œ**:
```json
{
  "model": "fixed_fractional",
  "risk_percent": 0.02
}
```

#### ğŸ“Š **4.2.2 ë³€ë™ì„± ê¸°ë°˜(Volatility-Adjusted) ì‚¬ì´ì§•**

**ì›ë¦¬**: ì‹œì¥ ë³€ë™ì„±ì— ë”°ë¼ í¬ì§€ì…˜ í¬ê¸°ë¥¼ ë™ì  ì¡°ì ˆ
- **ë†’ì€ ë³€ë™ì„±**: í¬ì§€ì…˜ í¬ê¸° ê°ì†Œ
- **ë‚®ì€ ë³€ë™ì„±**: í¬ì§€ì…˜ í¬ê¸° ì¦ê°€
- **ê²°ê³¼**: ë¦¬ìŠ¤í¬ ë…¸ì¶œì„ ì¼ì •í•˜ê²Œ ìœ ì§€

**ì£¼ìš” ì§€í‘œ**: í‰ê·  ì‹¤ì œ ë²”ìœ„(Average True Range, ATR)

**êµ¬í˜„ í”„ë¡œì„¸ìŠ¤**:
1. Capital Manager â†’ Exchange Connectorì— ìµœê·¼ OHLCV ë°ì´í„° ìš”ì²­
2. ATR ê³„ì‚°
3. Stop Loss Distance ëŒ€ì‹  ATR ì‚¬ìš©í•˜ì—¬ í¬ì§€ì…˜ í¬ê¸° ì •ê·œí™”

**ì„¤ì • ì˜ˆì‹œ**:
```json
{
  "model": "volatility_adjusted",
  "atr_period": 14,
  "volatility_multiplier": 2.0
}
```

#### ğŸ¯ **4.2.3 ì¼ˆë¦¬ ê¸°ì¤€(Kelly Criterion)**

**ëª©í‘œ**: ì¥ê¸°ì ì¸ ìë³¸ ì„±ì¥ë¥ ì„ ìˆ˜í•™ì ìœ¼ë¡œ ê·¹ëŒ€í™”
**ê¸°ë°˜**: ì „ëµì˜ ê³¼ê±° ì„±ê³¼ ë°ì´í„°

**í•µì‹¬ ì…ë ¥ê°’**:
- **p (ìŠ¹ë¥ , Win Probability)**: í•´ë‹¹ ì „ëµì˜ ê³¼ê±° ê±°ë˜ ì¤‘ ìˆ˜ìµì„ ë‚¸ ê±°ë˜ì˜ ë¹„ìœ¨
- **R (ì†ìµë¹„, Win/Loss Ratio)**: í‰ê·  ìˆ˜ìµ ê¸ˆì•¡ Ã· í‰ê·  ì†ì‹¤ ê¸ˆì•¡

**ê³„ì‚°ì‹**:
```
f = p - (1-p)/R
```
*ì—¬ê¸°ì„œ fëŠ” í¬íŠ¸í´ë¦¬ì˜¤ ìë³¸ ì¤‘ ë² íŒ…í•  ë¹„ìœ¨*

**êµ¬í˜„ ë°©ë²•**:
```python
def calculate_kelly_fraction(strategy_id):
    # trades í…Œì´ë¸”ì—ì„œ íŠ¹ì • strategy_id ê±°ë˜ ë‚´ì—­ ë¶„ì„
    # p (ìŠ¹ë¥ )ì™€ R (ì†ìµë¹„) ê³„ì‚°
    # ì¼ˆë¦¬ ë¹„ìœ¨ f ë°˜í™˜
```

#### âš ï¸ **í•µì‹¬ ê³ ë ¤ì‚¬í•­: ë¶„í•  ì¼ˆë¦¬(Fractional Kelly)**

**ìœ„í—˜ì„±**: ì•”í˜¸í™”í ì‹œì¥ì˜ ë†’ì€ ë³€ë™ì„±ê³¼ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥ì„±
**ë¬¸ì œ**: ìŠ¹ë¥  ê³¼ëŒ€í‰ê°€ ì‹œ í° ì†ì‹¤ ìœ„í—˜
**í•´ê²°ì±…**: ê³„ì‚°ëœ fê°’ì— 0.25ë‚˜ 0.5 ê°™ì€ ë¶„ìˆ˜(fraction) ê³±í•˜ì—¬ ë² íŒ… í¬ê¸° ê°ì†Œ

**ê¶Œì¥ ì„¤ì •**:
```json
{
  "model": "Kelly",
  "fraction": 0.5
}
```

**ì ˆëŒ€ì  ê¶Œì¥ì‚¬í•­**: ë¶„í•  ì¼ˆë¦¬ ë°©ì‹ ì ìš© í•„ìˆ˜

#### ğŸ¤– **4.2.4 ë¨¸ì‹ ëŸ¬ë‹ ê¸°ë°˜ ë™ì  ì‚¬ì´ì§• (ì‹ ê·œ ì¶”ê°€)**

**ëª©í‘œ**: ì‹œì¥ ì¡°ê±´, ì „ëµ ì„±ê³¼, í¬íŠ¸í´ë¦¬ì˜¤ ìƒíƒœë¥¼ ì¢…í•©ì ìœ¼ë¡œ ê³ ë ¤í•œ ì§€ëŠ¥í˜• í¬ì§€ì…˜ ì‚¬ì´ì§•

**ì…ë ¥ íŠ¹ì„±**:
- ì‹œì¥ ë³€ë™ì„± (VIX, ì•”í˜¸í™”í ê³µí¬ íƒìš• ì§€ìˆ˜)
- ì „ëµ ìµœê·¼ ì„±ê³¼ (ìŠ¹ë¥ , ìƒ¤í”„ ì§€ìˆ˜, ìµœëŒ€ ì†ì‹¤ë¥ )
- í¬íŠ¸í´ë¦¬ì˜¤ í˜„ì¬ ìƒíƒœ (ë…¸ì¶œë„, ìƒê´€ê´€ê³„)
- ê±°ì‹œê²½ì œ ì§€í‘œ (ê¸ˆë¦¬, ë‹¬ëŸ¬ ì§€ìˆ˜ ë“±)

**ëª¨ë¸ êµ¬ì¡°**:
```python
class MLPositionSizer:
    def __init__(self):
        self.model = self.load_trained_model()
        self.feature_engineer = FeatureEngineer()
        self.risk_adjuster = RiskAdjuster()
    
    def calculate_position_size(self, strategy_id: int, signal: dict) -> float:
        # íŠ¹ì„± ìƒì„±
        features = self.feature_engineer.create_features(
            strategy_id=strategy_id,
            market_data=signal['market_data'],
            portfolio_state=self.get_portfolio_state()
        )
        
        # ML ëª¨ë¸ ì˜ˆì¸¡
        predicted_size_ratio = self.model.predict(features.reshape(1, -1))[0]
        
        # ë¦¬ìŠ¤í¬ ì¡°ì •
        adjusted_ratio = self.risk_adjuster.apply_constraints(
            predicted_size_ratio, strategy_id
        )
        
        return adjusted_ratio
    
    def update_model(self, recent_trades: List[Dict]):
        """
        ìµœê·¼ ê±°ë˜ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ëª¨ë¸ ì¬í•™ìŠµ
        """
        if len(recent_trades) >= 100:  # ì¶©ë¶„í•œ ë°ì´í„° í™•ë³´ ì‹œ
            X, y = self.prepare_training_data(recent_trades)
            self.model.partial_fit(X, y)  # ì˜¨ë¼ì¸ í•™ìŠµ
```

**íŠ¹ì§•**:
- **ì ì‘ì„±**: ì‹œì¥ ì¡°ê±´ ë³€í™”ì— ìë™ ì ì‘
- **ê°œì¸í™”**: ê° ì „ëµì˜ ê³ ìœ í•œ íŠ¹ì„± í•™ìŠµ
- **ë¦¬ìŠ¤í¬ ì¸ì‹**: ë¶ˆí™•ì‹¤ì„±ì´ ë†’ì„ ë•Œ ë³´ìˆ˜ì  ì ‘ê·¼

### 4.3 ì‹œìŠ¤í…œ ì§€ì› ë²”ìœ„

**íˆ¬ì ìŠ¤íƒ€ì¼ ìˆ˜ìš© ë²”ìœ„**:
- âœ… ë‹¨ìˆœí•œ ë°˜ë³µ ë§¤ë§¤
- âœ… ì •êµí•œ í†µê³„ì  ë² íŒ… ì „ëµ
- âœ… ì†Œê·œëª¨ë¶€í„° ëŒ€ê·œëª¨ê¹Œì§€ ëª¨ë“  ìë³¸ ê·œëª¨
- âœ… AI ê¸°ë°˜ ì ì‘í˜• í¬ì§€ì…˜ ê´€ë¦¬

---

## ğŸ¯ 5. ê³ ê¸‰ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ê¸°ëŠ¥ (ì‹ ê·œ ì¶”ê°€)

### 5.1 ìƒê´€ê´€ê³„ ê¸°ë°˜ í¬íŠ¸í´ë¦¬ì˜¤ ìµœì í™”

**ëª©ì **: ê°œë³„ ì „ëµì˜ ìƒê´€ê´€ê³„ë¥¼ ê³ ë ¤í•œ í¬íŠ¸í´ë¦¬ì˜¤ ìˆ˜ì¤€ ë¦¬ìŠ¤í¬ ê´€ë¦¬

```python
class CorrelationBasedRiskManager:
    def __init__(self):
        self.correlation_matrix = None
        self.update_interval = 24 * 3600  # 24ì‹œê°„ë§ˆë‹¤ ì—…ë°ì´íŠ¸
        
    def calculate_portfolio_risk(self, proposed_allocations: Dict[int, float]) -> float:
        """
        ì œì•ˆëœ í¬ì§€ì…˜ í• ë‹¹ì— ëŒ€í•œ í¬íŠ¸í´ë¦¬ì˜¤ ì „ì²´ ë¦¬ìŠ¤í¬ ê³„ì‚°
        """
        if self.correlation_matrix is None:
            self.update_correlation_matrix()
        
        # ê° ì „ëµì˜ ì˜ˆìƒ ë³€ë™ì„±
        volatilities = self.get_strategy_volatilities(proposed_allocations.keys())
        
        # í¬íŠ¸í´ë¦¬ì˜¤ ë³€ë™ì„± ê³„ì‚° (ë§ˆì½”ìœ„ì¸  ëª¨ë¸)
        portfolio_variance = 0
        for i, (strategy_i, weight_i) in enumerate(proposed_allocations.items()):
            for j, (strategy_j, weight_j) in enumerate(proposed_allocations.items()):
                correlation = self.correlation_matrix[i][j]
                portfolio_variance += (
                    weight_i * weight_j * 
                    volatilities[strategy_i] * volatilities[strategy_j] * 
                    correlation
                )
        
        return math.sqrt(portfolio_variance)
    
    def suggest_optimal_allocation(self, requested_allocations: Dict[int, float]) -> Dict[int, float]:
        """
        ë¦¬ìŠ¤í¬-ìˆ˜ìµ ìµœì í™”ë¥¼ í†µí•œ í• ë‹¹ ì¡°ì • ì œì•ˆ
        """
        # ì œì•½ ì¡°ê±´ í•˜ì—ì„œ ìƒ¤í”„ ì§€ìˆ˜ ìµœëŒ€í™”
        constraints = [
            {'type': 'eq', 'fun': lambda x: sum(x) - 1},  # ì´ í• ë‹¹ = 100%
            {'type': 'ineq', 'fun': lambda x: 0.15 - self.calculate_portfolio_risk(x)}  # ìµœëŒ€ ë¦¬ìŠ¤í¬ 15%
        ]
        
        result = minimize(
            fun=self.negative_sharpe_ratio,
            x0=list(requested_allocations.values()),
            method='SLSQP',
            constraints=constraints,
            bounds=[(0, 0.5) for _ in requested_allocations]  # ê°œë³„ ì „ëµ ìµœëŒ€ 50%
        )
        
        return dict(zip(requested_allocations.keys(), result.x))
```

### 5.2 ë™ì  ë¦¬ìŠ¤í¬ ì˜ˆì‚° ê´€ë¦¬

**ê°œë…**: ì‹œì¥ ì¡°ê±´ì— ë”°ë¼ ì „ì²´ í¬íŠ¸í´ë¦¬ì˜¤ì˜ ë¦¬ìŠ¤í¬ ì˜ˆì‚°ì„ ë™ì ìœ¼ë¡œ ì¡°ì •

```python
class DynamicRiskBudgetManager:
    def __init__(self):
        self.market_regime_detector = MarketRegimeDetector()
        self.base_risk_budget = 0.02  # ê¸°ë³¸ 2% ë¦¬ìŠ¤í¬
        
    def get_current_risk_budget(self) -> float:
        """
        í˜„ì¬ ì‹œì¥ ìƒí™©ì— ë§ëŠ” ë¦¬ìŠ¤í¬ ì˜ˆì‚° ê³„ì‚°
        """
        market_regime = self.market_regime_detector.detect_current_regime()
        
        risk_multipliers = {
            'bull_market': 1.2,      # ìƒìŠ¹ì¥: 20% ì¦ê°€
            'bear_market': 0.6,      # í•˜ë½ì¥: 40% ê°ì†Œ
            'sideways': 1.0,         # íš¡ë³´: ê¸°ë³¸ê°’
            'high_volatility': 0.5,  # ê³ ë³€ë™ì„±: 50% ê°ì†Œ
            'low_volatility': 1.1    # ì €ë³€ë™ì„±: 10% ì¦ê°€
        }
        
        multiplier = risk_multipliers.get(market_regime, 1.0)
        adjusted_budget = self.base_risk_budget * multiplier
        
        # ì•ˆì „ ë²”ìœ„ ì œí•œ
        return max(0.005, min(0.05, adjusted_budget))  # 0.5% ~ 5% ë²”ìœ„
```

### 5.3 ì‹¤ì‹œê°„ VaR (Value at Risk) ëª¨ë‹ˆí„°ë§

**ëª©ì **: í¬íŠ¸í´ë¦¬ì˜¤ì˜ ì ì¬ì  ì†ì‹¤ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§

```python
class RealTimeVaRMonitor:
    def __init__(self, confidence_level=0.95):
        self.confidence_level = confidence_level
        self.historical_window = 252  # 1ë…„ê°„ ë°ì´í„°
        
    def calculate_portfolio_var(self, positions: Dict[str, float]) -> Dict[str, float]:
        """
        ëª¬í…Œì¹´ë¥¼ë¡œ ì‹œë®¬ë ˆì´ì…˜ì„ í†µí•œ VaR ê³„ì‚°
        """
        # ê³¼ê±° ìˆ˜ìµë¥  ë°ì´í„° ìˆ˜ì§‘
        returns_data = self.get_historical_returns(positions.keys())
        
        # ëª¬í…Œì¹´ë¥¼ë¡œ ì‹œë®¬ë ˆì´ì…˜
        num_simulations = 10000
        portfolio_returns = []
        
        for _ in range(num_simulations):
            # ëœë¤ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±
            scenario_returns = self.generate_random_scenario(returns_data)
            
            # í¬íŠ¸í´ë¦¬ì˜¤ ìˆ˜ìµë¥  ê³„ì‚°
            portfolio_return = sum(
                positions[asset] * scenario_returns[asset] 
                for asset in positions
            )
            portfolio_returns.append(portfolio_return)
        
        # VaR ê³„ì‚°
        sorted_returns = sorted(portfolio_returns)
        var_index = int((1 - self.confidence_level) * len(sorted_returns))
        
        return {
            'var_1day': sorted_returns[var_index],
            'var_1week': sorted_returns[var_index] * math.sqrt(7),
            'var_1month': sorted_returns[var_index] * math.sqrt(30),
            'expected_shortfall': sum(sorted_returns[:var_index]) / var_index
        }
```

---

## ğŸ¯ ì‹œìŠ¤í…œ í†µí•© íš¨ê³¼

### í•µì‹¬ ê°€ì¹˜ ì‹¤í˜„
- **ì¬ë¬´ì  ì•ˆì •ì„±**: ì¤‘ì•™ ì§‘ì¤‘ì‹ ë¦¬ìŠ¤í¬ ê´€ë¦¬
- **í™•ì¥ì„±**: ì†Œê·œëª¨ë¶€í„° ê¸°ê´€ê¸‰ê¹Œì§€ ëŒ€ì‘
- **ìœ ì—°ì„±**: ë‹¤ì–‘í•œ í¬ì§€ì…˜ ì‚¬ì´ì§• ëª¨ë¸ ì§€ì›
- **ì•ˆì „ì„±**: í¬íŠ¸í´ë¦¬ì˜¤ ìˆ˜ì¤€ ë¦¬ìŠ¤í¬ ê·œì¹™ ê°•ì œ
- **ì§€ëŠ¥ì„±**: ML ê¸°ë°˜ ì ì‘í˜• ë¦¬ìŠ¤í¬ ê´€ë¦¬

### ì‹œìŠ¤í…œ ì§„í™”
**ì´ì „**: ë‹¨ìˆœí•œ ê±°ë˜ ì‹¤í–‰ ë„êµ¬  
**ì´í›„**: ì§€ëŠ¥ì ì¸ í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë¦¬ í”Œë«í¼

### ê³ ê¸‰ ê¸°ëŠ¥ ì¶”ê°€ íš¨ê³¼
- **AI ê¸°ë°˜ ì˜ì‚¬ê²°ì •**: ë¨¸ì‹ ëŸ¬ë‹ ëª¨ë¸ì„ í†µí•œ ìµœì  í¬ì§€ì…˜ ì‚¬ì´ì§•
- **ë™ì  ì ì‘ì„±**: ì‹œì¥ ì¡°ê±´ ë³€í™”ì— ìë™ ëŒ€ì‘
- **í¬íŠ¸í´ë¦¬ì˜¤ ìµœì í™”**: í˜„ëŒ€ í¬íŠ¸í´ë¦¬ì˜¤ ì´ë¡  ì ìš©
- **ì‹¤ì‹œê°„ ë¦¬ìŠ¤í¬ ëª¨ë‹ˆí„°ë§**: VaR ê¸°ë°˜ ì†ì‹¤ ìœ„í—˜ ê°ì‹œ

---

## ğŸ“ ë¬¸ì„œ ê´€ë¦¬ ì •ë³´

**ì—°ê´€ ë¬¸ì„œ**: 
- `00_System_Overview_and_Architecture.md`
- `01_Core_Services_and_Execution_Framework.md`

**êµ¬í˜„ ìš°ì„ ìˆœìœ„**: 
1. Capital Manager ì„œë¹„ìŠ¤ êµ¬í˜„
2. ë°ì´í„° ëª¨ë¸ í™•ì¥
3. ê¸°ë³¸ í¬ì§€ì…˜ ì‚¬ì´ì§• ì•Œê³ ë¦¬ì¦˜ êµ¬í˜„
4. ML ê¸°ë°˜ ê³ ê¸‰ ê¸°ëŠ¥ ì¶”ê°€

**ë¦¬ìŠ¤í¬ ê´€ë¦¬**: ë¶„í•  ì¼ˆë¦¬ ë°©ì‹ ì ìš© í•„ìˆ˜, AI ëª¨ë¸ ì‹ ì¤‘í•œ ê²€ì¦ í•„ìš”